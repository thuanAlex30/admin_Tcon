<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý thiết bị bảo hộ - SafetyPro Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .breadcrumb {
            color: #666;
            font-size: 0.9rem;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }

        .tabs {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .tab-nav {
            display: flex;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .tab-button {
            flex: 1;
            padding: 1.5rem 2rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button.active {
            color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
        }

        .tab-content {
            padding: 2rem;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: rgba(108, 117, 125, 0.1);
            border: 2px solid rgba(108, 117, 125, 0.3);
            color: #6c757d;
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-filters {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex: 1;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.5rem;
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            outline: none;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            border-color: #3498db;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.2);
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #3498db;
        }

        .filter-select {
            padding: 0.8rem 1rem;
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            outline: none;
            cursor: pointer;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }

        .ppe-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .ppe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(155, 89, 182, 0.1));
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .card-subtitle {
            color: #666;
            font-size: 0.9rem;
        }

        .ppe-icon {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .ppe-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }

        .info-item i {
            color: #3498db;
            width: 16px;
        }

        .stock-status {
            background: rgba(52, 152, 219, 0.05);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .stock-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .stock-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .stock-alert {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            margin-top: 0.5rem;
        }

        .alert-low {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
            border: 2px solid rgba(243, 156, 18, 0.3);
        }

        .alert-out {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border: 2px solid rgba(231, 76, 60, 0.3);
        }

        .alert-good {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
            border: 2px solid rgba(46, 204, 113, 0.3);
        }

        .card-actions {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .data-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .table-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        th {
            background: rgba(52, 152, 219, 0.05);
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            color: #555;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-issued {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
            border: 2px solid rgba(243, 156, 18, 0.3);
        }

        .status-returned {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
            border: 2px solid rgba(46, 204, 113, 0.3);
        }

        .status-overdue {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border: 2px solid rgba(231, 76, 60, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #666;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .form-input {
            padding: 0.8rem 1rem;
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.2);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            .data-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-filters {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1><i class="fas fa-hard-hat"></i> Quản lý thiết bị bảo hộ</h1>
                <div class="breadcrumb">
                    <a href="index.html">Dashboard</a> / Thiết bị bảo hộ
                </div>
            </div>
            <a href="index.html" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab-nav">
                <button class="tab-button active" onclick="switchTab('items')">
                    <i class="fas fa-box"></i> Danh mục PPE
                </button>
                <button class="tab-button" onclick="switchTab('inventory')">
                    <i class="fas fa-warehouse"></i> Kho hàng
                </button>
                <button class="tab-button" onclick="switchTab('issuance')">
                    <i class="fas fa-hand-holding"></i> Phát PPE
                </button>
                <button class="tab-button" onclick="switchTab('tracking')">
                    <i class="fas fa-history"></i> Theo dõi
                </button>
            </div>

            <!-- PPE Items Tab -->
            <div class="tab-content active" id="items-tab">
                <div class="controls">
                    <div class="search-filters">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Tìm kiếm thiết bị..." id="itemSearch">
                        </div>
                        
                        <select class="filter-select" id="categoryFilter">
                            <option value="">Tất cả danh mục</option>
                            <option value="1">Bảo vệ đầu</option>
                            <option value="2">Bảo vệ mắt</option>
                            <option value="3">Bảo vệ hô hấp</option>
                            <option value="4">Bảo vệ chân tay</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" onclick="openModal('addItemModal')">
                        <i class="fas fa-plus"></i> Thêm thiết bị
                    </button>
                </div>

                <div class="data-grid" id="itemsGrid">
                    <!-- PPE items will be rendered here -->
                </div>
            </div>

            <!-- Inventory Tab -->
            <div class="tab-content" id="inventory-tab">
                <div class="controls">
                    <div class="search-filters">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Tìm kiếm kho..." id="inventorySearch">
                        </div>
                        
                        <select class="filter-select" id="siteFilter">
                            <option value="">Tất cả địa điểm</option>
                            <option value="1">Công trường A</option>
                            <option value="2">Công trường B</option>
                            <option value="3">Kho trung tâm</option>
                        </select>
                        
                        <select class="filter-select" id="stockFilter">
                            <option value="">Tất cả trạng thái</option>
                            <option value="low">Sắp hết</option>
                            <option value="out">Hết hàng</option>
                            <option value="good">Đầy đủ</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success" onclick="openModal('updateStockModal')">
                        <i class="fas fa-plus-circle"></i> Nhập kho
                    </button>
                </div>

                <div class="data-grid" id="inventoryGrid">
                    <!-- Inventory will be rendered here -->
                </div>
            </div>

            <!-- Issuance Tab -->
            <div class="tab-content" id="issuance-tab">
                <div class="controls">
                    <div class="search-filters">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Tìm kiếm theo tên nhân viên..." id="issuanceSearch">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="openModal('issueModal')">
                        <i class="fas fa-hand-holding"></i> Phát PPE
                    </button>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Lịch sử phát PPE</h3>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Nhân viên</th>
                                <th>Thiết bị</th>
                                <th>Số lượng</th>
                                <th>Ngày phát</th>
                                <th>Ngày trả dự kiến</th>
                                <th>Người phát</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="issuanceTable">
                            <!-- Issuance records will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tracking Tab -->
            <div class="tab-content" id="tracking-tab">
                <div class="controls">
                    <div class="search-filters">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Tìm kiếm..." id="trackingSearch">
                        </div>
                        
                        <select class="filter-select" id="trackingStatusFilter">
                            <option value="">Tất cả trạng thái</option>
                            <option value="issued">Đã phát</option>
                            <option value="returned">Đã trả</option>
                            <option value="overdue">Quá hạn</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success" onclick="exportTrackingReport()">
                        <i class="fas fa-download"></i> Xuất báo cáo
                    </button>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Theo dõi PPE</h3>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Nhân viên</th>
                                <th>Thiết bị</th>
                                <th>Số lượng</th>
                                <th>Ngày phát</th>
                                <th>Hạn trả</th>
                                <th>Ngày trả thực tế</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="trackingTable">
                            <!-- Tracking records will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add PPE Item Modal -->
    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Thêm thiết bị bảo hộ</h2>
                <span class="close-modal" onclick="closeModal('addItemModal')">&times;</span>
            </div>
            
            <form id="itemForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Mã thiết bị *</label>
                        <input type="text" class="form-input" id="itemCode" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tên thiết bị *</label>
                        <input type="text" class="form-input" id="itemName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Danh mục *</label>
                        <select class="form-input" id="categoryId" required>
                            <option value="">Chọn danh mục</option>
                            <option value="1">Bảo vệ đầu</option>
                            <option value="2">Bảo vệ mắt</option>
                            <option value="3">Bảo vệ hô hấp</option>
                            <option value="4">Bảo vệ chân tay</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Thương hiệu</label>
                        <input type="text" class="form-input" id="brand">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-input" id="model">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Mức tồn kho tối thiểu</label>
                        <input type="number" class="form-input" id="reorderLevel" min="0" value="10">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addItemModal')">
                        Hủy
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Thêm thiết bị
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Update Stock Modal -->
    <div id="updateStockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Cập nhật tồn kho</h2>
                <span class="close-modal" onclick="closeModal('updateStockModal')">&times;</span>
            </div>
            
            <form id="stockForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Thiết bị *</label>
                        <select class="form-input" id="stockItemId" required>
                            <option value="">Chọn thiết bị</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Địa điểm *</label>
                        <select class="form-input" id="stockSiteId" required>
                            <option value="">Chọn địa điểm</option>
                            <option value="1">Công trường A</option>
                            <option value="2">Công trường B</option>
                            <option value="3">Kho trung tâm</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Số lượng nhập *</label>
                        <input type="number" class="form-input" id="quantityToAdd" required min="1">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ghi chú</label>
                        <input type="text" class="form-input" id="stockNote" placeholder="Lý do nhập kho...">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('updateStockModal')">
                        Hủy
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus-circle"></i> Nhập kho
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Issue PPE Modal -->
    <div id="issueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Phát thiết bị bảo hộ</h2>
                <span class="close-modal" onclick="closeModal('issueModal')">&times;</span>
            </div>
            
            <form id="issueForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nhân viên *</label>
                        <select class="form-input" id="issueUserId" required>
                            <option value="">Chọn nhân viên</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Thiết bị *</label>
                        <select class="form-input" id="issueItemId" required>
                            <option value="">Chọn thiết bị</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Số lượng *</label>
                        <input type="number" class="form-input" id="issueQuantity" required min="1">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ngày trả dự kiến *</label>
                        <input type="date" class="form-input" id="expectedReturnDate" required>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('issueModal')">
                        Hủy
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-hand-holding"></i> Phát PPE
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Database-aligned data structures
        const ppeCategories = [
            { category_id: 1, category_name: "Bảo vệ đầu", description: "Nón bảo hộ, mũ cứng", lifespan_months: 12 },
            { category_id: 2, category_name: "Bảo vệ mắt", description: "Kính bảo hộ, mặt nạ", lifespan_months: 6 },
            { category_id: 3, category_name: "Bảo vệ hô hấp", description: "Khẩu trang, mặt nạ phòng độc", lifespan_months: 1 },
            { category_id: 4, category_name: "Bảo vệ chân tay", description: "Găng tay, giày bảo hộ", lifespan_months: 3 }
        ];

        const sites = [
            { site_id: 1, site_name: "Công trường A", address: "123 Đường ABC, Quận 1", is_active: true },
            { site_id: 2, site_name: "Công trường B", address: "456 Đường XYZ, Quận 2", is_active: true },
            { site_id: 3, site_name: "Kho trung tâm", address: "789 Đường DEF, Quận 3", is_active: true }
        ];

        const ppeItems = [
            {
                item_id: 1,
                category_id: 1,
                item_code: "HELMET-001",
                item_name: "Nón bảo hộ trắng",
                brand: "3M",
                model: "H-700",
                reorder_level: 20
            },
            {
                item_id: 2,
                category_id: 1,
                item_code: "HELMET-002", 
                item_name: "Nón bảo hộ vàng",
                brand: "MSA",
                model: "V-Gard",
                reorder_level: 15
            },
            {
                item_id: 3,
                category_id: 2,
                item_code: "GLASS-001",
                item_name: "Kính bảo hộ trong suốt",
                brand: "Honeywell",
                model: "A800",
                reorder_level: 30
            },
            {
                item_id: 4,
                category_id: 3,
                item_code: "MASK-001",
                item_name: "Khẩu trang N95",
                brand: "3M",
                model: "8210",
                reorder_level: 100
            },
            {
                item_id: 5,
                category_id: 4,
                item_code: "GLOVE-001",
                item_name: "Găng tay da",
                brand: "Ansell",
                model: "PowerFlex",
                reorder_level: 50
            },
            {
                item_id: 6,
                category_id: 4,
                item_code: "BOOT-001",
                item_name: "Giày bảo hộ da",
                brand: "Red Wing",
                model: "2412",
                reorder_level: 25
            }
        ];

        const ppeInventory = [
            { inventory_id: 1, item_id: 1, site_id: 1, quantity_available: 45, quantity_allocated: 15, last_updated: "2024-03-10T14:30:00" },
            { inventory_id: 2, item_id: 1, site_id: 2, quantity_available: 32, quantity_allocated: 8, last_updated: "2024-03-10T14:30:00" },
            { inventory_id: 3, item_id: 1, site_id: 3, quantity_available: 120, quantity_allocated: 0, last_updated: "2024-03-10T14:30:00" },
            { inventory_id: 4, item_id: 2, site_id: 1, quantity_available: 28, quantity_allocated: 12, last_updated: "2024-03-10T14:30:00" },
            { inventory_id: 5, item_id: 3, site_id: 1, quantity_available: 85, quantity_allocated: 25, last_updated: "2024-03-10T14:30:00" },
            { inventory_id: 6, item_id: 4, site_id: 1, quantity_available: 250, quantity_allocated: 50, last_updated: "2024-03-10T14:30:00" },
            { inventory_id: 7, item_id: 5, site_id: 1, quantity_available: 75, quantity_allocated: 25, last_updated: "2024-03-10T14:30:00" },
            { inventory_id: 8, item_id: 6, site_id: 1, quantity_available: 18, quantity_allocated: 7, last_updated: "2024-03-10T14:30:00" },
            { inventory_id: 9, item_id: 4, site_id: 2, quantity_available: 8, quantity_allocated: 2, last_updated: "2024-03-10T14:30:00" }
        ];

        const users = [
            { user_id: 1, full_name: "Nguyễn Văn An", email: "an.nguyen@company.com", department: "Kỹ thuật" },
            { user_id: 2, full_name: "Trần Thị Bình", email: "binh.tran@company.com", department: "An toàn" },
            { user_id: 3, full_name: "Lê Văn Cường", email: "cuong.le@company.com", department: "Sản xuất" },
            { user_id: 4, full_name: "Phạm Thị Dung", email: "dung.pham@company.com", department: "Kỹ thuật" },
            { user_id: 5, full_name: "Hoàng Văn Em", email: "em.hoang@company.com", department: "Bảo trì" },
            { user_id: 100, full_name: "Admin User", email: "admin@company.com", department: "Quản lý" }
        ];

        const ppeIssuances = [
            {
                issuance_id: 1,
                user_id: 1,
                item_id: 1,
                quantity: 1,
                issued_date: "2024-03-01",
                expected_return_date: "2024-09-01",
                issued_by: 100,
                status: "issued"
            },
            {
                issuance_id: 2,
                user_id: 2,
                item_id: 3,
                quantity: 2,
                issued_date: "2024-03-05",
                expected_return_date: "2024-09-05",
                issued_by: 100,
                status: "issued"
            },
            {
                issuance_id: 3,
                user_id: 3,
                item_id: 4,
                quantity: 10,
                issued_date: "2024-02-15",
                expected_return_date: "2024-03-15",
                issued_by: 100,
                status: "overdue"
            },
            {
                issuance_id: 4,
                user_id: 4,
                item_id: 5,
                quantity: 2,
                issued_date: "2024-01-20",
                expected_return_date: "2024-04-20",
                issued_by: 100,
                status: "returned"
            },
            {
                issuance_id: 5,
                user_id: 5,
                item_id: 6,
                quantity: 1,
                issued_date: "2024-03-08",
                expected_return_date: "2024-12-08",
                issued_by: 100,
                status: "issued"
            }
        ];

        // Filtered data arrays
        let filteredItems = [...ppeItems];
        let filteredInventory = [...ppeInventory];
        let filteredIssuances = [...ppeIssuances];

        // Utility functions
        function getCategoryName(categoryId) {
            const category = ppeCategories.find(c => c.category_id === categoryId);
            return category ? category.category_name : 'Không xác định';
        }

        function getCategoryIcon(categoryId) {
            const icons = {
                1: 'fas fa-hard-hat',
                2: 'fas fa-glasses',
                3: 'fas fa-head-side-mask',
                4: 'fas fa-mitten'
            };
            return icons[categoryId] || 'fas fa-box';
        }

        function getSiteName(siteId) {
            const site = sites.find(s => s.site_id === siteId);
            return site ? site.site_name : 'Không xác định';
        }

        function getItemName(itemId) {
            const item = ppeItems.find(i => i.item_id === itemId);
            return item ? item.item_name : 'Không xác định';
        }

        function getUserName(userId) {
            const user = users.find(u => u.user_id === userId);
            return user ? user.full_name : 'Không xác định';
        }

        function getStockStatus(available, reorderLevel) {
            if (available === 0) return 'out';
            if (available <= reorderLevel) return 'low';
            return 'good';
        }

        function getStockStatusLabel(status) {
            const labels = {
                'out': 'Hết hàng',
                'low': 'Sắp hết',
                'good': 'Đầy đủ'
            };
            return labels[status] || status;
        }

        function getStatusLabel(status) {
            const labels = {
                'issued': 'Đã phát',
                'returned': 'Đã trả',
                'overdue': 'Quá hạn'
            };
            return labels[status] || status;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('vi-VN');
        }

        function formatDateTime(dateTimeString) {
            return new Date(dateTimeString).toLocaleString('vi-VN');
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            switch(tabName) {
                case 'items':
                    renderItems();
                    break;
                case 'inventory':
                    renderInventory();
                    break;
                case 'issuance':
                    renderIssuances();
                    populateUsers();
                    populateIssueItems();
                    break;
                case 'tracking':
                    renderTracking();
                    break;
            }
        }

        // Render functions
        function renderItems() {
            const grid = document.getElementById('itemsGrid');
            
            grid.innerHTML = filteredItems.map(item => {
                const totalStock = ppeInventory
                    .filter(inv => inv.item_id === item.item_id)
                    .reduce((sum, inv) => sum + inv.quantity_available, 0);
                
                const stockStatus = getStockStatus(totalStock, item.reorder_level);
                
                return `
                    <div class="ppe-card">
                        <div class="card-header">
                            <div class="card-title">${item.item_name}</div>
                            <div class="card-subtitle">${item.item_code}</div>
                            <div class="ppe-icon">
                                <i class="${getCategoryIcon(item.category_id)}"></i>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <div class="ppe-info">
                                <div class="info-item">
                                    <i class="fas fa-layer-group"></i>
                                    <span>${getCategoryName(item.category_id)}</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-copyright"></i>
                                    <span>${item.brand || 'Không xác định'}</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-tag"></i>
                                    <span>${item.model || 'Không xác định'}</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>Min: ${item.reorder_level}</span>
                                </div>
                            </div>
                            
                            <div class="stock-status">
                                <div class="stock-title">Tổng tồn kho</div>
                                <div class="stock-row">
                                    <span>Có sẵn:</span>
                                    <span>${totalStock}</span>
                                </div>
                                <div class="stock-alert alert-${stockStatus}">
                                    ${getStockStatusLabel(stockStatus)}
                                </div>
                            </div>
                            
                            <div class="card-actions">
                                <button class="btn btn-warning btn-sm" onclick="editItem(${item.item_id})">
                                    <i class="fas fa-edit"></i> Sửa
                                </button>
                                <button class="btn btn-success btn-sm" onclick="viewItemStock(${item.item_id})">
                                    <i class="fas fa-warehouse"></i> Kho
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="viewItemHistory(${item.item_id})">
                                    <i class="fas fa-history"></i> Lịch sử
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderInventory() {
            const grid = document.getElementById('inventoryGrid');
            
            const inventoryWithDetails = filteredInventory.map(inv => {
                const item = ppeItems.find(i => i.item_id === inv.item_id);
                const site = sites.find(s => s.site_id === inv.site_id);
                const stockStatus = getStockStatus(inv.quantity_available, item?.reorder_level || 0);
                
                return {
                    ...inv,
                    item_name: item?.item_name || 'Không xác định',
                    item_code: item?.item_code || 'N/A',
                    category_id: item?.category_id || 1,
                    site_name: site?.site_name || 'Không xác định',
                    reorder_level: item?.reorder_level || 0,
                    stock_status: stockStatus
                };
            });
            
            grid.innerHTML = inventoryWithDetails.map(inv => `
                <div class="ppe-card">
                    <div class="card-header">
                        <div class="card-title">${inv.item_name}</div>
                        <div class="card-subtitle">${inv.site_name}</div>
                        <div class="ppe-icon">
                            <i class="${getCategoryIcon(inv.category_id)}"></i>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="ppe-info">
                            <div class="info-item">
                                <i class="fas fa-code"></i>
                                <span>${inv.item_code}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-calendar"></i>
                                <span>${formatDateTime(inv.last_updated)}</span>
                            </div>
                        </div>
                        
                        <div class="stock-status">
                            <div class="stock-title">Tình trạng kho</div>
                            <div class="stock-row">
                                <span>Có sẵn:</span>
                                <span>${inv.quantity_available}</span>
                            </div>
                            <div class="stock-row">
                                <span>Đã phát:</span>
                                <span>${inv.quantity_allocated}</span>
                            </div>
                            <div class="stock-row">
                                <span>Tối thiểu:</span>
                                <span>${inv.reorder_level}</span>
                            </div>
                            <div class="stock-alert alert-${inv.stock_status}">
                                ${getStockStatusLabel(inv.stock_status)}
                            </div>
                        </div>
                        
                        <div class="card-actions">
                            <button class="btn btn-success btn-sm" onclick="updateInventory(${inv.inventory_id})">
                                <i class="fas fa-plus"></i> Nhập
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="adjustInventory(${inv.inventory_id})">
                                <i class="fas fa-edit"></i> Điều chỉnh
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderIssuances() {
            const tbody = document.getElementById('issuanceTable');
            
            tbody.innerHTML = filteredIssuances.map(issuance => `
                <tr>
                    <td style="font-weight: 600; color: #2c3e50;">${getUserName(issuance.user_id)}</td>
                    <td>${getItemName(issuance.item_id)}</td>
                    <td style="text-align: center; font-weight: 600;">${issuance.quantity}</td>
                    <td>${formatDate(issuance.issued_date)}</td>
                    <td>${formatDate(issuance.expected_return_date)}</td>
                    <td>${getUserName(issuance.issued_by)}</td>
                    <td>
                        <span class="status-badge status-${issuance.status}">
                            ${getStatusLabel(issuance.status)}
                        </span>
                    </td>
                    <td>
                        ${issuance.status === 'issued' || issuance.status === 'overdue' ? 
                            `<button class="btn btn-success btn-sm" onclick="returnPPE(${issuance.issuance_id})">
                                <i class="fas fa-undo"></i> Trả về
                            </button>` : 
                            `<button class="btn btn-secondary btn-sm" onclick="viewIssuanceDetails(${issuance.issuance_id})">
                                <i class="fas fa-eye"></i> Xem
                            </button>`
                        }
                    </td>
                </tr>
            `).join('');
        }

        function renderTracking() {
            const tbody = document.getElementById('trackingTable');
            
            tbody.innerHTML = filteredIssuances.map(issuance => `
                <tr>
                    <td style="font-weight: 600; color: #2c3e50;">${getUserName(issuance.user_id)}</td>
                    <td>${getItemName(issuance.item_id)}</td>
                    <td style="text-align: center; font-weight: 600;">${issuance.quantity}</td>
                    <td>${formatDate(issuance.issued_date)}</td>
                    <td>${formatDate(issuance.expected_return_date)}</td>
                    <td>${issuance.status === 'returned' ? formatDate(issuance.actual_return_date || issuance.expected_return_date) : '-'}</td>
                    <td>
                        <span class="status-badge status-${issuance.status}">
                            ${getStatusLabel(issuance.status)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="viewTrackingDetails(${issuance.issuance_id})">
                            <i class="fas fa-search"></i> Chi tiết
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Populate dropdown functions
        function populateStockItems() {
            const select = document.getElementById('stockItemId');
            select.innerHTML = '<option value="">Chọn thiết bị</option>' + 
                ppeItems.map(item => `<option value="${item.item_id}">${item.item_name} (${item.item_code})</option>`).join('');
        }

        function populateUsers() {
            const select = document.getElementById('issueUserId');
            const activeUsers = users.filter(user => user.user_id !== 100); // Exclude admin
            select.innerHTML = '<option value="">Chọn nhân viên</option>' + 
                activeUsers.map(user => `<option value="${user.user_id}">${user.full_name} - ${user.department}</option>`).join('');
        }

        function populateIssueItems() {
            const select = document.getElementById('issueItemId');
            select.innerHTML = '<option value="">Chọn thiết bị</option>' + 
                ppeItems.map(item => `<option value="${item.item_id}">${item.item_name} (${item.item_code})</option>`).join('');
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            
            if (modalId === 'updateStockModal') {
                populateStockItems();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.querySelector(`#${modalId} form`).reset();
        }

        // Filter functions
        function filterItems() {
            const searchTerm = document.getElementById('itemSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;

            filteredItems = ppeItems.filter(item => {
                const matchesSearch = item.item_name.toLowerCase().includes(searchTerm) ||
                                    item.item_code.toLowerCase().includes(searchTerm) ||
                                    (item.brand && item.brand.toLowerCase().includes(searchTerm));
                const matchesCategory = !categoryFilter || item.category_id.toString() === categoryFilter;

                return matchesSearch && matchesCategory;
            });

            renderItems();
        }

        function filterInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const siteFilter = document.getElementById('siteFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;

            filteredInventory = ppeInventory.filter(inv => {
                const item = ppeItems.find(i => i.item_id === inv.item_id);
                const site = sites.find(s => s.site_id === inv.site_id);
                const stockStatus = getStockStatus(inv.quantity_available, item?.reorder_level || 0);
                
                const matchesSearch = item?.item_name.toLowerCase().includes(searchTerm) ||
                                    item?.item_code.toLowerCase().includes(searchTerm) ||
                                    site?.site_name.toLowerCase().includes(searchTerm);
                const matchesSite = !siteFilter || inv.site_id.toString() === siteFilter;
                const matchesStock = !stockFilter || stockStatus === stockFilter;

                return matchesSearch && matchesSite && matchesStock;
            });

            renderInventory();
        }

        function filterIssuances() {
            const searchTerm = document.getElementById('issuanceSearch').value.toLowerCase();

            filteredIssuances = ppeIssuances.filter(issuance => {
                const userName = getUserName(issuance.user_id);
                const itemName = getItemName(issuance.item_id);
                
                return userName.toLowerCase().includes(searchTerm) ||
                       itemName.toLowerCase().includes(searchTerm);
            });

            renderIssuances();
        }

        function filterTracking() {
            const searchTerm = document.getElementById('trackingSearch').value.toLowerCase();
            const statusFilter = document.getElementById('trackingStatusFilter').value;

            filteredIssuances = ppeIssuances.filter(issuance => {
                const userName = getUserName(issuance.user_id);
                const itemName = getItemName(issuance.item_id);
                
                const matchesSearch = userName.toLowerCase().includes(searchTerm) ||
                                    itemName.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || issuance.status === statusFilter;

                return matchesSearch && matchesStatus;
            });

            renderTracking();
        }

        // Event listeners
        document.getElementById('itemSearch').addEventListener('input', filterItems);
        document.getElementById('categoryFilter').addEventListener('change', filterItems);
        document.getElementById('inventorySearch').addEventListener('input', filterInventory);
        document.getElementById('siteFilter').addEventListener('change', filterInventory);
        document.getElementById('stockFilter').addEventListener('change', filterInventory);
        document.getElementById('issuanceSearch').addEventListener('input', filterIssuances);
        document.getElementById('trackingSearch').addEventListener('input', filterTracking);
        document.getElementById('trackingStatusFilter').addEventListener('change', filterTracking);

        // Form submissions
        document.getElementById('itemForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                item_code: document.getElementById('itemCode').value,
                item_name: document.getElementById('itemName').value,
                category_id: parseInt(document.getElementById('categoryId').value),
                brand: document.getElementById('brand').value,
                model: document.getElementById('model').value,
                reorder_level: parseInt(document.getElementById('reorderLevel').value) || 10
            };

            const newItem = {
                item_id: ppeItems.length + 1,
                ...formData
            };
            
            ppeItems.push(newItem);
            filterItems();
            closeModal('addItemModal');
            alert('Đã thêm thiết bị mới thành công!');
        });

        document.getElementById('stockForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const itemId = parseInt(document.getElementById('stockItemId').value);
            const siteId = parseInt(document.getElementById('stockSiteId').value);
            const quantityToAdd = parseInt(document.getElementById('quantityToAdd').value);
            
            // Find existing inventory record
            const existingInv = ppeInventory.find(inv => 
                inv.item_id === itemId && inv.site_id === siteId
            );
            
            if (existingInv) {
                existingInv.quantity_available += quantityToAdd;
                existingInv.last_updated = new Date().toISOString();
            } else {
                // Create new inventory record
                const newInv = {
                    inventory_id: ppeInventory.length + 1,
                    item_id: itemId,
                    site_id: siteId,
                    quantity_available: quantityToAdd,
                    quantity_allocated: 0,
                    last_updated: new Date().toISOString()
                };
                ppeInventory.push(newInv);
            }
            
            filterInventory();
            closeModal('updateStockModal');
            alert('Đã cập nhật tồn kho thành công!');
        });

        document.getElementById('issueForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userId = parseInt(document.getElementById('issueUserId').value);
            const itemId = parseInt(document.getElementById('issueItemId').value);
            const quantity = parseInt(document.getElementById('issueQuantity').value);
            const expectedReturnDate = document.getElementById('expectedReturnDate').value;
            
            // Check inventory availability
            const totalAvailable = ppeInventory
                .filter(inv => inv.item_id === itemId)
                .reduce((sum, inv) => sum + inv.quantity_available, 0);
            
            if (totalAvailable < quantity) {
                alert('Không đủ số lượng trong kho!');
                return;
            }
            
            // Create issuance record
            const newIssuance = {
                issuance_id: ppeIssuances.length + 1,
                user_id: userId,
                item_id: itemId,
                quantity: quantity,
                issued_date: new Date().toISOString().split('T')[0],
                expected_return_date: expectedReturnDate,
                issued_by: 100, // Admin user
                status: 'issued'
            };
            
            ppeIssuances.push(newIssuance);
            
            // Update inventory
            let remainingQuantity = quantity;
            for (let inv of ppeInventory.filter(i => i.item_id === itemId)) {
                if (remainingQuantity <= 0) break;
                
                const canTake = Math.min(inv.quantity_available, remainingQuantity);
                inv.quantity_available -= canTake;
                inv.quantity_allocated += canTake;
                remainingQuantity -= canTake;
            }
            
            filterIssuances();
            closeModal('issueModal');
            alert('Đã phát PPE thành công!');
        });

        // Action functions
        function editItem(itemId) {
            const item = ppeItems.find(i => i.item_id === itemId);
            if (item) {
                document.querySelector('#addItemModal .modal-title').textContent = 'Chỉnh sửa thiết bị';
                document.getElementById('itemCode').value = item.item_code;
                document.getElementById('itemName').value = item.item_name;
                document.getElementById('categoryId').value = item.category_id;
                document.getElementById('brand').value = item.brand || '';
                document.getElementById('model').value = item.model || '';
                document.getElementById('reorderLevel').value = item.reorder_level;
                openModal('addItemModal');
            }
        }

        function viewItemStock(itemId) {
            const item = ppeItems.find(i => i.item_id === itemId);
            const inventoryRecords = ppeInventory.filter(inv => inv.item_id === itemId);
            
            if (item) {
                let stockDetails = `Chi tiết tồn kho - ${item.item_name}\n\n`;
                
                inventoryRecords.forEach(inv => {
                    const siteName = getSiteName(inv.site_id);
                    stockDetails += `${siteName}:\n`;
                    stockDetails += `  - Có sẵn: ${inv.quantity_available}\n`;
                    stockDetails += `  - Đã phát: ${inv.quantity_allocated}\n`;
                    stockDetails += `  - Cập nhật: ${formatDateTime(inv.last_updated)}\n\n`;
                });
                
                const totalAvailable = inventoryRecords.reduce((sum, inv) => sum + inv.quantity_available, 0);
                const totalAllocated = inventoryRecords.reduce((sum, inv) => sum + inv.quantity_allocated, 0);
                
                stockDetails += `Tổng cộng:\n`;
                stockDetails += `  - Tổng có sẵn: ${totalAvailable}\n`;
                stockDetails += `  - Tổng đã phát: ${totalAllocated}\n`;
                stockDetails += `  - Mức tối thiểu: ${item.reorder_level}`;
                
                alert(stockDetails);
            }
        }

        function viewItemHistory(itemId) {
            const item = ppeItems.find(i => i.item_id === itemId);
            const itemIssuances = ppeIssuances.filter(iss => iss.item_id === itemId);
            
            if (item) {
                let history = `Lịch sử sử dụng - ${item.item_name}\n\n`;
                
                if (itemIssuances.length === 0) {
                    history += 'Chưa có lịch sử phát hành.';
                } else {
                    itemIssuances.forEach(issuance => {
                        const userName = getUserName(issuance.user_id);
                        const statusLabel = getStatusLabel(issuance.status);
                        
                        history += `${userName} - ${issuance.quantity} cái\n`;
                        history += `  Ngày phát: ${formatDate(issuance.issued_date)}\n`;
                        history += `  Hạn trả: ${formatDate(issuance.expected_return_date)}\n`;
                        history += `  Trạng thái: ${statusLabel}\n\n`;
                    });
                }
                
                alert(history);
            }
        }

        function updateInventory(inventoryId) {
            const inventory = ppeInventory.find(inv => inv.inventory_id === inventoryId);
            if (inventory) {
                const item = ppeItems.find(i => i.item_id === inventory.item_id);
                const site = sites.find(s => s.site_id === inventory.site_id);
                
                document.getElementById('stockItemId').value = inventory.item_id;
                document.getElementById('stockSiteId').value = inventory.site_id;
                
                // Pre-populate dropdowns
                populateStockItems();
                
                openModal('updateStockModal');
            }
        }

        function adjustInventory(inventoryId) {
            const inventory = ppeInventory.find(inv => inv.inventory_id === inventoryId);
            if (inventory) {
                const item = ppeItems.find(i => i.item_id === inventory.item_id);
                const adjustment = prompt(`Điều chỉnh tồn kho cho ${item.item_name}\nSố lượng hiện tại: ${inventory.quantity_available}\nNhập số lượng mới:`, inventory.quantity_available);
                
                if (adjustment !== null && !isNaN(adjustment) && adjustment >= 0) {
                    inventory.quantity_available = parseInt(adjustment);
                    inventory.last_updated = new Date().toISOString();
                    renderInventory();
                    alert('Đã điều chỉnh tồn kho thành công!');
                }
            }
        }

        function returnPPE(issuanceId) {
            const issuance = ppeIssuances.find(iss => iss.issuance_id === issuanceId);
            if (issuance && confirm(`Xác nhận trả PPE?\n\nNhân viên: ${getUserName(issuance.user_id)}\nThiết bị: ${getItemName(issuance.item_id)}\nSố lượng: ${issuance.quantity}`)) {
                
                // Update issuance status
                issuance.status = 'returned';
                issuance.actual_return_date = new Date().toISOString().split('T')[0];
                
                // Return to inventory
                const inventory = ppeInventory.find(inv => 
                    inv.item_id === issuance.item_id && inv.quantity_allocated >= issuance.quantity
                );
                
                if (inventory) {
                    inventory.quantity_available += issuance.quantity;
                    inventory.quantity_allocated -= issuance.quantity;
                    inventory.last_updated = new Date().toISOString();
                }
                
                renderIssuances();
                alert('Đã xác nhận trả PPE thành công!');
            }
        }

        function viewIssuanceDetails(issuanceId) {
            const issuance = ppeIssuances.find(iss => iss.issuance_id === issuanceId);
            if (issuance) {
                const details = `Chi tiết phát PPE\n\nNhân viên: ${getUserName(issuance.user_id)}\nThiết bị: ${getItemName(issuance.item_id)}\nSố lượng: ${issuance.quantity}\nNgày phát: ${formatDate(issuance.issued_date)}\nHạn trả: ${formatDate(issuance.expected_return_date)}\nNgày trả thực tế: ${issuance.actual_return_date ? formatDate(issuance.actual_return_date) : 'Chưa trả'}\nNguười phát: ${getUserName(issuance.issued_by)}\nTrạng thái: ${getStatusLabel(issuance.status)}`;
                
                alert(details);
            }
        }

        function viewTrackingDetails(issuanceId) {
            viewIssuanceDetails(issuanceId);
        }

        function exportTrackingReport() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Nhân viên,Thiết bị,Số lượng,Ngày phát,Hạn trả,Ngày trả thực tế,Trạng thái\n"
                + ppeIssuances.map(issuance => [
                    getUserName(issuance.user_id),
                    getItemName(issuance.item_id),
                    issuance.quantity,
                    formatDate(issuance.issued_date),
                    formatDate(issuance.expected_return_date),
                    issuance.actual_return_date ? formatDate(issuance.actual_return_date) : '',
                    getStatusLabel(issuance.status)
                ].join(',')).join('\n');

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `ppe_tracking_report_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Set default date for issue form
        function setDefaultReturnDate() {
            const today = new Date();
            const sixMonthsLater = new Date(today);
            sixMonthsLater.setMonth(today.getMonth() + 6);
            
            const dateString = sixMonthsLater.toISOString().split('T')[0];
            document.getElementById('expectedReturnDate').value = dateString;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            switchTab('items');
            setDefaultReturnDate();
        });
    </script>
</body>
</html>